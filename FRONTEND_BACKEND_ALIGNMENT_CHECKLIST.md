## 前后端对齐用确认清单（联调前快速收敛）

用于与后端在联调前快速确认接口契约、字段含义与运行策略。清单按优先级与主题分组，覆盖“增量分析 + 历史合并 + LLM 决策 + 信息补充 + 自动保存 + 强推”的端到端流程。

---

### 一、环境与网关（基础信息）

- [ ] 服务环境域名与路径（dev/staging/prod）：`__________`
- [ ] 统一鉴权方式（Cookie/Token/签名）：`__________`
- [ ] CORS/CSRF/TLS 配置：`__________`
- [ ] API 版本路径（如 /api/v1）：`__________`
- [ ] 统一错误码表与语义文档链接：`__________`

---

### 二、高优先级（必须确认）

#### 2.1 基础符号与行情字段字典

- [ ] 标的代码格式统一（示例 HK.00700、US.AAPL），是否包含 A 股/其他市场规则差异：`__________`
- [ ] SSE quote 最小保证字段集合与类型：
  - [ ] price：`number` 单位：`__________`
  - [ ] volume：`number`
  - [ ] bid/ask（如有）：`__________`
  - [ ] open/high/low/prev_close/turnover：`__________`
  - [ ] timestamp 单位（秒/毫秒，小数是否允许）：`__________`
- [ ] 事件名与数据结构固定为 `welcome|quote|heartbeat`，是否需要 data 内含 `type` 字段：`__________`

#### 2.2 订阅覆盖与多标签页策略

- [ ] POST `/api/quote/subscribe_push` 是否覆盖绑定（重复调用覆盖旧列表）：`是/否`
- [ ] 最大订阅数限制、去重策略：`__________`
- [ ] client_id 唯一性要求、过期/清理策略（无心跳清理间隔）：`__________`
- [ ] 同账号多标签页并行策略（允许同账号不同 client_id 并行）：`是/否`

#### 2.3 LLM 分析聚合

- [ ] POST `/api/llm/analyze` 入参与出参是否与契约一致（含 model、latestQuote、deltas、history、可选 extraInfo）：`是/否`
- [ ] 返回是否强制包含 `latest_basis`、`level('urgent'|'consider'|'observe')`、`need_more_info`、`info_requests`：`是/否`
- [ ] 模型不可用时的降级与错误码：`__________`
- [ ] 超时与重试策略、速率限制（每账号/每IP）与请求体上限：`__________`

#### 2.4 信息补充数据

- [ ] POST `/api/info/fetch` 支持的 `types` 与返回结构（news/filings/tech/calendar/macro）：`__________`
- [ ] 数据来源、时效性保证、更新时间字段：`__________`
- [ ] 新闻/公告是否做摘要（LLM/规则）、语言与编码（中/英）、是否支持分页与增量拉取：`__________`

#### 2.5 市场状态判断

- [ ] GET `/api/market/status` 是否按市场区分（HK/US/CN），区分盘前/盘中/盘后：`__________`
- [ ] 时区与节假日来源、同一 code 的市场映射规则：`__________`

#### 2.6 历史分析存储

- [ ] GET `/api/analysis/history` 的分页与排序（时间倒序）、默认 limit、是否支持按时间范围筛选：`__________`
- [ ] POST `/api/analysis/save` 幂等策略（是否支持客户端自带 id 或服务端生成）、一致性保证：`__________`

---

### 三、中优先级（尽快确认）

#### 3.1 SSE 连接稳健性

- [ ] 心跳频率与负载策略（每 N 秒一条）：`__________`
- [ ] 是否支持 Last-Event-ID 续传：`是/否`
- [ ] 代理/负载均衡下的长连接策略（超时、断连重连）：`__________`
- [ ] 是否要求客户端指数退避与最大重连时长：`__________`
- [ ] 反向代理是否设置 `X-Accel-Buffering: no` 或等效：`__________`

#### 3.2 关注列表的“来源真相”

- [ ] 是否提供账号级 watchlist 接口（GET `/api/watchlist`、POST `/api/watchlist/set`）：`是/否`
- [ ] 与 `subscribe_push` 的关系与触发链路（变更后是否服务端自动绑定订阅）：`__________`

#### 3.3 安全与鉴权

- [ ] 新增接口是否走统一鉴权，CORS/CSRF/TLS：`__________`
- [ ] 不同环境的域名与网关路径（dev/staging/prod）：`__________`
- [ ] 密钥在服务端托管还是前端透传（LLM/info 源）：`__________`

#### 3.4 错误码与版本管理

- [ ] 统一错误码与字段级报错（缺参/类型不符/模型不可用/超限）：`__________`
- [ ] 版本策略（/api/v1/...）、向后兼容与弃用周期、变更公告方式：`__________`

---

### 四、低优先级（联调中完善）

#### 4.1 性能与 SLA

- [ ] SSE 单连接消息大小上限、单位时间推送峰值、平均延时预算：`__________`
- [ ] LLM 分析平均/峰值延时、并发上限、失败率阈值与熔断/降级：`__________`

#### 4.2 监控与审计

- [ ] 日志与指标（耗时、失败率、模型成本、info 命中率），是否支持 request_id/trace_id：`__________`
- [ ] 合规审计：LLM 输入/输出审计、敏感词过滤、调用频次配额：`__________`

#### 4.3 边界与特殊事件

- [ ] 停牌、临时停市、涨跌停、拆股/更名/并表等公司行为的传递方式与提示：`__________`
- [ ] 无行情时（休市/链路故障）仅推心跳？是否有“数据陈旧”标记：`__________`

---

### 五、样例与说明（用于前端快速适配）

- [ ] SSE quote 样例（多市场、多字段、含时间戳与数值精度）
- [ ] LLM analyze 请求/响应样例（含 need_more_info=true 与二次复评）
- [ ] info/fetch 返回样例（news/filings/calendar/tech/macro 各一）
- [ ] market/status 在不同交易阶段样例
- [ ] analysis/history/save 的样例与分页/limit 说明
- [ ] 错误与限流样例（超限、鉴权失败、模型/数据源不可用；含返回格式和关键 Header）

> 注：若与《FRONTEND_INTEGRATION_GUIDE.md》存在差异，请在此标注“最终契约”为准，并抄送前端以更新调用层与类型定义。

---

### 六、联调准备与验收标准（前端视角）

#### 6.1 验收用例

- [ ] 新增关注 → 自动订阅 → 开市收到 quote → 增量计算 → 首次 LLM 判断 → need_more_info → 拉取补充信息 → 二次 LLM 复评 → 保存 → UI 分类（紧急强推）
- [ ] 多标签页不同 client_id 并行订阅与独立推送
- [ ] 休市仅心跳、停牌/公告大事件、模型故障降级完整链路

#### 6.2 时序与性能基线

- [ ] quote→建议端到端耗时：目标 `__________`，上限 `__________`
- [ ] SSE 重连恢复时长：目标 `__________`
- [ ] 单账号接口配额与失败重试上限：`__________`

---

### 七、最终回传（由后端填写）

- [ ] 字段与契约已对齐（若不一致，附差异说明与最终契约链接）
- [ ] 环境地址与鉴权方式已确认
- [ ] 超时/限流/错误码表与样例已提供
- [ ] 测试数据与联调窗口已确认

> 前端说明：收到“最终契约/差异点”后，我们会将 hooks/services/types 的实现与变更一次性落地至项目，并提供改动点清单。


